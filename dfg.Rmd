---
title: "Insuffient critical care resources led to increased COVID-19 mortality in Toronto"
author: "Lai Jiang"
date: "20/01/2022"
output:
  pdf_document: default
  word_document: default
abstract: In this paper
---
# 1 Introduction

```{r, message=FALSE, echo=FALSE}
library(magrittr)
library(janitor)
library(dplyr)
library(ggplot2)
library(reshape2)
library(readr)
library(opendatatoronto)
library(tmap)
library(maptools)
library(rgeos)
library(ggmap)
library(plotfunctions)
```
# 2 Data
## 2.1 Data source
This report utilizes a data set containing demographic, geographic, and severity information for all confirmed and probable cases reported to and managed by Toronto Public Health since the first case was reported in January 2020. The data are extracted from the provincial Case & Contact Management System (CCM) (Open Data Toronto, 2020). Toronto Public Health (TPH), in partnership with the Province of Ontario, administrates the case and contact management component of the City’s COVID-19 response (Toronto.ca, 2021). The COVID-19 data set discussed in this report was extracted from the R package opendatatoronto in the form of csv. The data will be completely refreshed and overwritten on a weekly basis. (Open Data Toronto, 2020)

## 2.2 Methodology and Data Collection
The dataset contains information on the number of cases of COVID-19 in Toronto recorded by Toronto Public Health. A case is considered as a confirmed case in three ways. Firstly, a confirmed case is identified when there is detection of at least one specific gene target by a validated laboratory-based NAAT assay performed at a community, hospital or reference laboratory. Or there is a validated POC NAAT that has been deemed acceptable by the Ontario Ministry of Health to provide a final result. Lastly, the person demonstrated seroconversion within a 4 week interval in viral specific antibody in serum or plasma using a validated laboratory-based serological assay for SARS-CoV-2 (Ontario Ministry of Health, 2022). However, the standard of a confirmed case has been constantly changing since the first case was identified in January, 2020. These changes in standard will lead to an increase of bias in the data. 

Reported cases of COVID-19 are generally understood to only capture a subset of the actual number of cases. There are several reasons for this. Surveillance systems can only capture those cases that sought medical care (or at least sought testing), and received a diagnostic test that was determined to be “positive”, that was subsequently reported back to the surveillance system. Many cases of COVID-19 are mild in severity, which reduces the likelihood that they would seek medical care and testing. Policies that restrict who can be tested (to, for example, healthcare workers, or those that exhibit a specific set of symptoms) can also cause under-ascertainment of cases. Additionally, a low percentage of individuals with COVID-19 may falsely test negative in diagnostic tests (Dougherty et al., 2021). The contagiousness, dynamics of the pathogen, and mobility of the general population also incurred the occurrence of underestimation of infection (i.e., the unidentified cases and the gap with the identified cases) that was potentially substantial in magnitude. If infectious individuals were identified timely and effectively then the efficacy of measures could be increased significantly and thus concentrating effort on the quarantining of the most infectious cases would be at work than the case of mere random control. However, such kind of mechanism was compromised during a pandemic in which transmission was established before the onset of symptoms or visible symptoms were not present (Nakamoto and Zhang, 2021). 

Data related to hospitalization may also fail to reflect the true numbers. As a result of the increased number of patients needing critical care beds during the pandemic, some hospitals changed their protocols regarding which types of patients were admitted to specific ICUs, e.g., admitting COVID-19 related critical illness patients to cardiac surgical ICUs. These changes happened fluidly and are not easily tracked in the database (Ontario COVID-19 Science Advisory Table, 2021). Therefore the number of patients treated in ICU can be inaccurate. 


## 2.3 Data Characteristics
The COVID-19 dataset contains information on the number of cases of COVID-19 in Toronto recorded by Toronto Public Health from January 2020 to now. There are in total 277473 observations (The dataset is updated weekly and numbers may be different after the update) and 18 attributes including 6 socio-demographic variables (id, assigned ID, gender, age group, neighbourhood name and FSA [the first segment of the postal code]), 6 virus related variables (outbreak associated, source of infection, classification [confirmed or probable], episode date, reported date and outcome) and 6 hospitalization variables (currently hospitalized, currently in ICU, currently intubated, ever hospitalized, ever in ICU and ever intubated). Based on the interest of the study, this report mainly focuses on the discussion of of 6 variables including age group, neighbourhood name, classification, source of infection, outcome and ever in ICU. A sample view of the 6 attributes is shown below.
```{r, echo=FALSE}
raw_data <- list_package_resources("https://open.toronto.ca/dataset/covid-19-cases-in-toronto/")
r <- raw_data %>%
  get_resource()
data <- clean_names(r)
data <- filter(data, classification == "CONFIRMED") %>%
  filter(!is.na(neighbourhood_name))
sample_view <- data[,c(4,5,7,8,12,17)]
head(sample_view)
```


## 2.4 Insufficient ICU resources





```{r, echo=FALSE}
fatal <- filter(data, classification == "CONFIRMED" & outcome == "FATAL")
hos <- fatal %>%
  count(age_group, ever_in_icu)
intu <- fatal %>%
  count(age_group, ever_intubated)
ggplot(hos, aes(x=age_group, y=n, fill=ever_in_icu)) +
    geom_bar(stat='identity', position='dodge') + labs(title = "Figure 1: Fatal cases classified by ever in ICU", x = "age group", y = "number of cases") + theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) + guides(fill=guide_legend(title="ever in ICU"))
```



## 2.5 Source of infection



```{r, echo=FALSE}
source1 <- fatal %>%
  filter(outcome != "ACTIVE")
source <- source1 %>%
  count(source_of_infection, ever_in_icu)
ggplot(source, aes(x=source_of_infection, y=n, fill=ever_in_icu)) +
    geom_bar(stat='identity', position='dodge') + theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) + guides(fill=guide_legend(title="ever in ICU")) + labs(title = "Source of infection of fatal cases classified by ever in ICU", x = "age group", y = "source of infection")
```







## 2.6 Location




```{r, echo=FALSE, message=FALSE, warning=FALSE}
shpfile <- "~/Desktop/neigh/NEIGHBORHOODS_WGS84_2.shp"
sh <- readShapeSpatial(shpfile)
```
```{r, echo=FALSE}
xia <- data %>%
  mutate(nei_id = case_when(
neighbourhood_name	==	"West Humber-Clairville"	~	1	,
neighbourhood_name	==	"Mount Olive-Silverstone-Jamestown"	~	2	,
neighbourhood_name	==	"Thistletown-Beaumond Heights"	~	3	,
neighbourhood_name	==	"Rexdale-Kipling"	~	4	,
neighbourhood_name	==	"Elms-Old Rexdale"	~	5	,
neighbourhood_name	==	"Kingsview Village-The Westway"	~	6	,
neighbourhood_name	==	"Willowridge-Martingrove-Richview"	~	7	,
neighbourhood_name	==	"Humber Heights-Westmount"	~	8	,
neighbourhood_name	==	"Edenbridge-Humber Valley"	~	9	,
neighbourhood_name	==	"Princess-Rosethorn"	~	10	,
neighbourhood_name	==	"Eringate-Centennial-West Deane"	~	11	,
neighbourhood_name	==	"Markland Wood"	~	12	,
neighbourhood_name	==	"Etobicoke West Mall"	~	13	,
neighbourhood_name	==	"Islington-City Centre West"	~	14	,
neighbourhood_name	==	"Kingsway South"	~	15	,
neighbourhood_name	==	"Stonegate-Queensway"	~	16	,
neighbourhood_name	==	"Mimico (includes Humber Bay Shores)"	~	17	,
neighbourhood_name	==	"New Toronto"	~	18	,
neighbourhood_name	==	"Long Branch"	~	19	,
neighbourhood_name	==	"Alderwood"	~	20	,
neighbourhood_name	==	"Humber Summit"	~	21	,
neighbourhood_name	==	"Humbermede"	~	22	,
neighbourhood_name	==	"Pelmo Park-Humberlea"	~	23	,
neighbourhood_name	==	"Black Creek"	~	24	,
neighbourhood_name	==	"Glenfield-Jane Heights"	~	25	,
neighbourhood_name	==	"Downsview-Roding-CFB"	~	26	,
neighbourhood_name	==	"York University Heights"	~	27	,
neighbourhood_name	==	"Rustic"	~	28	,
neighbourhood_name	==	"Maple Leaf"	~	29	,
neighbourhood_name	==	"Brookhaven-Amesbury"	~	30	,
neighbourhood_name	==	"Yorkdale-Glen Park"	~	31	,
neighbourhood_name	==	"Englemount-Lawrence"	~	32	,
neighbourhood_name	==	"Clanton Park"	~	33	,
neighbourhood_name	==	"Bathurst Manor"	~	34	,
neighbourhood_name	==	"Westminster-Branson"	~	35	,
neighbourhood_name	==	"Newtonbrook West"	~	36	,
neighbourhood_name	==	"Willowdale West"	~	37	,
neighbourhood_name	==	"Lansing-Westgate"	~	38	,
neighbourhood_name	==	"Bedford Park-Nortown"	~	39	,
neighbourhood_name	==	"St.Andrew-Windfields"	~	40	,
neighbourhood_name	==	"Bridle Path-Sunnybrook-York Mills"	~	41	,
neighbourhood_name	==	"Banbury-Don Mills"	~	42	,
neighbourhood_name	==	"Victoria Village"	~	43	,
neighbourhood_name	==	"Flemingdon Park"	~	44	,
neighbourhood_name	==	"Parkwoods-Donalda"	~	45	,
neighbourhood_name	==	"Pleasant View"	~	46	,
neighbourhood_name	==	"Don Valley Village"	~	47	,
neighbourhood_name	==	"Hillcrest Village"	~	48	,
neighbourhood_name	==	"Bayview Woods-Steeles"	~	49	,
neighbourhood_name	==	"Newtonbrook East"	~	50	,
neighbourhood_name	==	"Willowdale East"	~	51	,
neighbourhood_name	==	"Bayview Village"	~	52	,
neighbourhood_name	==	"Henry Farm"	~	53	,
neighbourhood_name	==	"O'Connor-Parkview"	~	54	,
neighbourhood_name	==	"Thorncliffe Park"	~	55	,
neighbourhood_name	==	"Leaside-Bennington"	~	56	,
neighbourhood_name	==	"Broadview North"	~	57	,
neighbourhood_name	==	"Old East York"	~	58	,
neighbourhood_name	==	"Danforth-East York"	~	59	,
neighbourhood_name	==	"Woodbine-Lumsden"	~	60	,
neighbourhood_name	==	"Taylor-Massey"	~	61	,
neighbourhood_name	==	"East End-Danforth"	~	62	,
neighbourhood_name	==	"The Beaches"	~	63	,
neighbourhood_name	==	"Woodbine Corridor"	~	64	,
neighbourhood_name	==	"Greenwood-Coxwell"	~	65	,
neighbourhood_name	==	"Danforth"	~	66	,
neighbourhood_name	==	"Playter Estates-Danforth"	~	67	,
neighbourhood_name	==	"North Riverdale"	~	68	,
neighbourhood_name	==	"Blake-Jones"	~	69	,
neighbourhood_name	==	"South Riverdale"	~	70	,
neighbourhood_name	==	"Cabbagetown-South St. James Town"	~	71	,
neighbourhood_name	==	"Regent Park"	~	72	,
neighbourhood_name	==	"Moss Park"	~	73	,
neighbourhood_name	==	"North St. James Town"	~	74	,
neighbourhood_name	==	"Church-Yonge Corridor"	~	75	,
neighbourhood_name	==	"Bay Street Corridor"	~	76	,
neighbourhood_name	==	"Waterfront Communities-The Island"	~	77	,
neighbourhood_name	==	"Kensington-Chinatown"	~	78	,
neighbourhood_name	==	"University"	~	79	,
neighbourhood_name	==	"Palmerston-Little Italy"	~	80	,
neighbourhood_name	==	"Trinity-Bellwoods"	~	81	,
neighbourhood_name	==	"Niagara"	~	82	,
neighbourhood_name	==	"Dufferin Grove"	~	83	,
neighbourhood_name	==	"Little Portugal"	~	84	,
neighbourhood_name	==	"South Parkdale"	~	85	,
neighbourhood_name	==	"Roncesvalles"	~	86	,
neighbourhood_name	==	"High Park-Swansea"	~	87	,
neighbourhood_name	==	"High Park North"	~	88	,
neighbourhood_name	==	"Runnymede-Bloor West Village"	~	89	,
neighbourhood_name	==	"Junction Area"	~	90	,
neighbourhood_name	==	"Weston-Pellam Park"	~	91	,
neighbourhood_name	==	"Corso Italia-Davenport"	~	92	,
neighbourhood_name	==	"Dovercourt-Wallace Emerson-Junction"	~	93	,
neighbourhood_name	==	"Wychwood"	~	94	,
neighbourhood_name	==	"Annex"	~	95	,
neighbourhood_name	==	"Casa Loma"	~	96	,
neighbourhood_name	==	"Yonge-St.Clair"	~	97	,
neighbourhood_name	==	"Rosedale-Moore Park"	~	98	,
neighbourhood_name	==	"Mount Pleasant East"	~	99	,
neighbourhood_name	==	"Yonge-Eglinton"	~	100	,
neighbourhood_name	==	"Forest Hill South"	~	101	,
neighbourhood_name	==	"Forest Hill North"	~	102	,
neighbourhood_name	==	"Lawrence Park South"	~	103	,
neighbourhood_name	==	"Mount Pleasant West"	~	104	,
neighbourhood_name	==	"Lawrence Park North"	~	105	,
neighbourhood_name	==	"Humewood-Cedarvale"	~	106	,
neighbourhood_name	==	"Oakwood Village"	~	107	,
neighbourhood_name	==	"Briar Hill - Belgravia"	~	108	,
neighbourhood_name	==	"Caledonia-Fairbank"	~	109	,
neighbourhood_name	==	"Keelesdale-Eglinton West"	~	110	,
neighbourhood_name	==	"Rockcliffe-Smythe"	~	111	,
neighbourhood_name	==	"Beechborough-Greenbrook"	~	112	,
neighbourhood_name	==	"Weston"	~	113	,
neighbourhood_name	==	"Lambton Baby Point"	~	114	,
neighbourhood_name	==	"Mount Dennis"	~	115	,
neighbourhood_name	==	"Steeles"	~	116	,
neighbourhood_name	==	"L'Amoreaux"	~	117	,
neighbourhood_name	==	"Tam O'Shanter-Sullivan"	~	118	,
neighbourhood_name	==	"Wexford/Maryvale"	~	119	,
neighbourhood_name	==	"Clairlea-Birchmount"	~	120	,
neighbourhood_name	==	"Oakridge"	~	121	,
neighbourhood_name	==	"Birchcliffe-Cliffside"	~	122	,
neighbourhood_name	==	"Cliffcrest"	~	123	,
neighbourhood_name	==	"Kennedy Park"	~	124	,
neighbourhood_name	==	"Ionview"	~	125	,
neighbourhood_name	==	"Dorset Park"	~	126	,
neighbourhood_name	==	"Bendale"	~	127	,
neighbourhood_name	==	"Agincourt South-Malvern West"	~	128	,
neighbourhood_name	==	"Agincourt North"	~	129	,
neighbourhood_name	==	"Milliken"	~	130	,
neighbourhood_name	==	"Rouge"	~	131	,
neighbourhood_name	==	"Malvern"	~	132	,
neighbourhood_name	==	"Centennial Scarborough"	~	133	,
neighbourhood_name	==	"Highland Creek"	~	134	,
neighbourhood_name	==	"Morningside"	~	135	,
neighbourhood_name	==	"West Hill"	~	136	,
neighbourhood_name	==	"Woburn"	~	137	,
neighbourhood_name	==	"Eglinton East"	~	138	,
neighbourhood_name	==	"Scarborough Village"	~	139	,
neighbourhood_name	==	"Guildwood"	~	140))

```
```{r, echo=FALSE, warning=FALSE}
sh@data$AREA_S_CD <- as.numeric(sh@data$AREA_S_CD)
demo <- xia %>%
  filter(ever_in_icu == "Yes")
sh2 <- merge(sh, demo, by.x='AREA_S_CD', by.y='nei_id', duplicateGeoms = TRUE)
loc <- xia %>%
  count(nei_id, ever_in_icu) %>%
  filter(ever_in_icu == "Yes")
p <- colorRampPalette(c("white", "red"))(128)
palette(p)

icu <- loc$n
cols <- (icu - min(icu))/diff(range(icu))*127+1
plot(sh2, col=cols)
gradientLegend(valRange = c(1, 81), color = p, side = 1)
```

```{r}


```

